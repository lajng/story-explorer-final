import{openDB as E}from"https://cdn.jsdelivr.net/npm/idb@7/+esm";import*as s from"https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function r(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=r(n);fetch(n.href,i)}})();const f={async renderLoginPage(){const e=document.createElement("section");return e.className="page",e.id="login-page",e.innerHTML=`
      <h1>Login</h1>
      <form id="login-form">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required />

        <label for="login-password">Password</label>
        <input type="password" id="login-password" required />

        <button type="submit" class="btn btn-primary">Login</button>
      </form>
      <div id="login-message" class="form-message"></div>
    `,e},async renderRegisterPage(){const e=document.createElement("section");return e.className="page",e.id="register-page",e.innerHTML=`
      <h1>Register</h1>
      <form id="register-form">
        <label for="register-name">Nama</label>
        <input type="text" id="register-name" required />

        <label for="register-email">Email</label>
        <input type="email" id="register-email" required />

        <label for="register-password">Password</label>
        <input type="password" id="register-password" required />

        <button type="submit" class="btn btn-primary">Daftar</button>
      </form>
      <div id="register-message" class="form-message"></div>
    `,e},showLoginMessage(e,t=!1){const r=document.getElementById("login-message");r&&(r.textContent=e,r.style.color=t?"red":"green")},showRegisterMessage(e,t=!1){const r=document.getElementById("register-message");r&&(r.textContent=e,r.style.color=t?"red":"green")}},L="story-explorer-db",g="favorite-stories";async function m(){return E(L,1,{upgrade(e){e.objectStoreNames.contains(g)||e.createObjectStore(g,{keyPath:"id"})}})}async function v(e){await(await m()).put(g,e)}async function M(e){const r=await(await m()).getAll(g);e(r)}async function T(e){await(await m()).delete(g,e)}const c={render(e){const t=document.getElementById("story-list");t.innerHTML="",e.forEach(r=>{const o=document.createElement("div");o.className="story-card",o.innerHTML=`
        <h3>${r.title||"Tanpa Judul"}</h3>
        <p>${r.description}</p>
        <button class="btn-favorite" data-story='${JSON.stringify(r)}'>‚ù§Ô∏è Simpan ke Favorite</button>
      `,t.appendChild(o)}),t.addEventListener("click",r=>{if(r.target.classList.contains("btn-favorite")){const o=JSON.parse(r.target.getAttribute("data-story"));v(o),alert("Story disimpan ke Favorite!")}})},renderFavoriteStoriesPage(){const e=document.createElement("section");return e.className="page",e.id="favorites-page",e.innerHTML=`
      <h2>Favorite Stories</h2>
      <div id="favorites-container" class="story-list"></div>
    `,M().then(t=>{const r=e.querySelector("#favorites-container");t.length===0?r.innerHTML="<p>Tidak ada story favorit.</p>":(t.forEach(o=>{const n=document.createElement("div");n.className="story-card",n.innerHTML=`
            <h3>${o.title||"Tanpa Judul"}</h3>
            <p>${o.description}</p>
            <button data-id="${o.id}" class="delete-btn">üóëÔ∏è Hapus</button>
          `,r.appendChild(n)}),r.addEventListener("click",o=>{if(o.target.classList.contains("delete-btn")){const n=o.target.getAttribute("data-id");T(n).then(()=>{o.target.closest(".story-card").remove()})}}))}),e},renderHomePage(){const e=document.createElement("section");return e.className="page",e.id="home-page",e.innerHTML=`
      <h2>Story Terbaru</h2>
      <div id="story-list" class="story-list">Loading...</div>
    `,e},renderAddStoryPage(){const e=document.createElement("section");return e.className="page",e.id="add-story-page",e.innerHTML=`
      <h2>Tambah Cerita</h2>
      <form id="add-story-form">
        <input type="text" id="title" name="title" placeholder="Judul" required />
        <textarea id="description" name="description" placeholder="Deskripsi" required></textarea>
        <button type="submit">Kirim</button>
      </form>
    `,e}},p="user_token",d={setToken(e){localStorage.setItem(p,e)},getToken(){return localStorage.getItem(p)},isAuthenticated(){return!!this.getToken()},logout(){localStorage.removeItem(p),location.hash="#login"}},w={init(){const e=document.getElementById("login-form"),t=document.getElementById("register-form");e&&e.addEventListener("submit",this.handleLogin),t&&t.addEventListener("submit",this.handleRegister);const r=document.getElementById("logout-button");r&&r.addEventListener("click",()=>{d.logout(),window.location.hash="#login"})},initRegisterHandler(){const e=document.getElementById("register-form");e&&e.addEventListener("submit",this.handleRegister)},async handleLogin(e){e.preventDefault();const t=document.getElementById("login-email").value.trim(),r=document.getElementById("login-password").value.trim(),o=document.getElementById("login-message");try{const n=await fetch("https://story-api.dicoding.dev/v1/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:r})}),i=await n.json();if(!n.ok)throw new Error(i.message);d.setToken(i.loginResult.token),o.textContent="Login berhasil!",o.style.color="green",setTimeout(()=>{window.location.hash="#home"},1e3)}catch(n){d.logout(),o.textContent="Login gagal: "+n.message,o.style.color="red"}},async handleRegister(e){e.preventDefault();const t=document.getElementById("register-name").value.trim(),r=document.getElementById("register-email").value.trim(),o=document.getElementById("register-password").value.trim(),n=document.getElementById("register-message");if(!t||!r||!o){n.textContent="Semua field harus diisi.",n.style.color="red";return}if(o.length<6){n.textContent="Password minimal 6 karakter.",n.style.color="red";return}try{const i=await fetch("https://story-api.dicoding.dev/v1/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:r,password:o})}),a=await i.json();if(!i.ok)throw new Error(a.message);n.textContent="Registrasi berhasil! Silakan login.",n.style.color="green",e.target.reset(),setTimeout(()=>{window.location.hash="#login"},1e3)}catch(i){n.textContent="Gagal daftar: "+i.message,n.style.color="red"}}},l={storyMap:null,addStoryMap:null,initStoryMap(e){const t=document.getElementById("stories-map");t&&(this.storyMap&&this.storyMap.remove(),this.storyMap=s.map(t).setView([-6.2,106.8],5),s.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(this.storyMap),setTimeout(()=>{this.storyMap.invalidateSize()},500),e.forEach(r=>{r.lat&&r.lon&&s.marker([r.lat,r.lon]).addTo(this.storyMap).bindPopup(`<strong>${r.name}</strong><br>${r.description}`)}))},initAddStoryMap(){const e=document.getElementById("location-map");if(!e)return;this.addStoryMap&&this.addStoryMap.remove(),this.addStoryMap=s.map(e).setView([-6.2,106.8],10),s.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(this.addStoryMap),setTimeout(()=>{this.addStoryMap.invalidateSize()},500);let t=null;this.addStoryMap.on("click",function(r){const{lat:o,lng:n}=r.latlng;t?t.setLatLng([o,n]):t=s.marker([o,n]).addTo(l.addStoryMap),window.AppState=window.AppState||{},window.AppState.currentLocation={lat:o.toFixed(6),lon:n.toFixed(6)}})}},b={async loadStories(){const e=d.getToken();if(!e){window.location.hash="#login";return}try{const t=await fetch("https://story-api.dicoding.dev/v1/stories",{headers:{Authorization:`Bearer ${e}`}});if(t.status===401){d.logout(),window.location.hash="#login";return}const r=await t.json();if(!t.ok)throw new Error(r.message||"Gagal memuat cerita");c.renderStoryList(r.listStory),l.initStoryMap(r.listStory),setTimeout(()=>{l.storyMap&&l.storyMap.invalidateSize()},300)}catch(t){c.renderError(t.message||"Terjadi kesalahan saat memuat cerita.")}},initSubmitHandler(){const e=document.getElementById("story-form");e&&(e.addEventListener("submit",async t=>{t.preventDefault();const r=document.getElementById("story-description").value,o=window.AppState?.capturedPhoto,n=window.AppState?.currentLocation;if(!o){alert("Silakan ambil foto terlebih dahulu.");return}if(!n){alert("Silakan pilih lokasi terlebih dahulu.");return}const i=new FormData;i.append("description",r),i.append("lat",n.lat),i.append("lon",n.lon),i.append("photo",o);try{const a=d.getToken();if(!a){alert("Anda harus login terlebih dahulu."),window.location.hash="#login";return}const y=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${a}`},body:i}),u=await y.json();if(!y.ok)throw new Error(u.message);alert("Cerita berhasil ditambahkan!"),v({id:u.story.id||Date.now().toString(),title:u.story.name||"Cerita Offline",body:r,lat:n.lat,lon:n.lon,createdAt:new Date().toISOString()}),window.location.hash="#home"}catch(a){alert("Gagal mengirim cerita: "+a.message)}}),l.initAddStoryMap())}},k="BObTt6J9Ey2b......";function A(e){const t="=".repeat((4-e.length%4)%4),r=(e+t).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(r),n=new Uint8Array(o.length);for(let i=0;i<o.length;++i)n[i]=o.charCodeAt(i);return n}function B(){"Notification"in window&&Notification.requestPermission().then(e=>{e==="granted"&&S()})}function S(){navigator.serviceWorker.ready.then(e=>{e.pushManager&&e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:A(k)}).then(t=>{console.log("Berhasil subscribe push:",t)}).catch(t=>{console.error("Gagal subscribe push:",t)})})}const h={init:async()=>{await m(),"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const e=await navigator.serviceWorker.register("/sw.js");console.log("‚úÖ Service Worker registered:",e),await B(),await S(e)}catch(e){console.error("‚ùå SW registration/push failed:",e)}}),window.addEventListener("hashchange",h.route),window.addEventListener("DOMContentLoaded",h.route)},route:async()=>{const e=window.location.hash||"#login",t=document.getElementById("main-content");switch(t.innerHTML="",e){case"#register":t.appendChild(await f.renderRegisterPage()),w.initRegisterHandler();break;case"#login":t.appendChild(await f.renderLoginPage()),w.initLoginHandler();break;case"#home":t.appendChild(await c.renderHomePage()),b.loadStories();break;case"#add-story":t.appendChild(await c.renderAddStoryPage()),b.initSubmitHandler();break;case"#favorites":t.appendChild(await c.renderFavoriteStoriesPage());break;default:t.innerHTML="<p>Halaman tidak ditemukan</p>"}}};h.init();
